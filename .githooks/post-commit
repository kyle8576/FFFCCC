#!/bin/bash
#
# Kenaz Cortex - Git Post-Commit Hook
#
# 在每次 commit 後自動觸發 RAG 增量索引更新。
# 支援非同步執行，不阻塞 commit 流程。
#
# 安裝方式：
#   git config core.hooksPath .githooks
#
# 或使用安裝腳本：
#   ./dev/scripts/hooks/install_hooks.sh (Linux/Mac)
#   .\dev\scripts\hooks\Install-GitHooks.ps1 (Windows)

# 取得專案根目錄
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 配置
CORTEX_SYNC_TIMEOUT=30  # 同步超時秒數

# 顏色輸出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 檢查是否在 CI 環境中
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
    echo "CI environment detected, skipping Cortex sync"
    exit 0
fi

# 檢查配置文件中是否啟用 git_hooks
check_hooks_enabled() {
    local config_file="$PROJECT_ROOT/.cortex.yaml"

    if [ -f "$config_file" ]; then
        # 使用 grep 檢查配置（避免依賴 yq）
        if grep -q "git_hooks:" "$config_file" && grep -q "enabled: true" "$config_file"; then
            return 0
        fi
    fi

    # 預設啟用
    return 0
}

# 檢查 Python 環境
check_python() {
    if command -v python3 &> /dev/null; then
        echo "python3"
    elif command -v python &> /dev/null; then
        echo "python"
    else
        echo ""
    fi
}

# 執行增量同步
run_sync() {
    local python_cmd=$1
    local async_mode=$2

    cd "$PROJECT_ROOT"

    if [ "$async_mode" = "true" ]; then
        # 非同步模式：背景執行
        (
            "$python_cmd" -m cortex.sync.git_sync --incremental > /dev/null 2>&1
        ) &
        disown
        echo -e "${BLUE}Kenaz Cortex:${NC} Index update started (background)"
    else
        # 同步模式：等待完成
        echo -e "${BLUE}Kenaz Cortex:${NC} Updating index..."

        if timeout "$CORTEX_SYNC_TIMEOUT" "$python_cmd" -m cortex.sync.git_sync --incremental 2>&1; then
            echo -e "${GREEN}Kenaz Cortex:${NC} Index updated successfully"
        else
            local exit_code=$?
            if [ $exit_code -eq 124 ]; then
                echo -e "${YELLOW}Kenaz Cortex:${NC} Index update timed out (non-blocking)"
            else
                echo -e "${YELLOW}Kenaz Cortex:${NC} Index update failed (non-blocking)"
            fi
        fi
    fi
}

# 主程式
main() {
    # 檢查是否啟用
    if ! check_hooks_enabled; then
        exit 0
    fi

    # 檢查 Python
    local python_cmd=$(check_python)
    if [ -z "$python_cmd" ]; then
        echo -e "${YELLOW}Kenaz Cortex:${NC} Python not found, skipping index update"
        exit 0
    fi

    # 檢查 cortex 模組是否可用
    if ! "$python_cmd" -c "import cortex" 2>/dev/null; then
        # Cortex 未安裝，靜默跳過
        exit 0
    fi

    # 執行同步（預設非同步模式）
    run_sync "$python_cmd" "true"

    exit 0
}

main
